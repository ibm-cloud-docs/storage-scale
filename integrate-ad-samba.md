---

copyright:
  years: 2022, 2023
lastupdated: "2023-10-18"

keywords: 

subcollection: storage-scale

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:external: target="_blank" .external}
{:pre: .pre}
{:tip: .tip}
{:note: .note}
{:important: .important}
{:ui: .ph data-hd-interface='ui'}
{:cli: .ph data-hd-interface='cli'}
{:api: .ph data-hd-interface='api'}
{:table: .aria-labeledby="caption"}

# Integrating Symphony Cluster running on RHEL 8.4 based Systems Directly to AD using Samba Winbind
{: #scale-integrate-symph-cluster-ad-samba}

## Overview of Direct Integration by using Samba Winbind
{: #integrate-symph-samba-intro}

To connect an RHEL system to Active Directory (AD), two components are needed: Samba Winbind and realmd. Samba Winbind interacts with the AD identity and authentication source, while realmd detects available domains and configures the underlying RHEL system services.

In this section, you will explore how to connect a RHEL system to AD using Samba Winbind. The steps include an overview of the direct integration process, supported Windows platforms, ensuring encryption compatibility, joining the AD domain, and using realm commands.

## Supported Windows Platforms and OSs for Direct Integration
{: #supported-windows-platforms}

Direct integration with AD forests is compatible with the following forest and domain functional levels:
*  Forest functional level range: Windows Server 2008 - Windows Server 2016
*  Domain functional level range: Windows Server 2008 - Windows Server 2016

Supported operating systems for direct integration include:
*  Windows Server 2022 (RHEL 8.7 and above)
*  Windows Server 2019
*  Windows Server 2016
*  Windows Server 2012 R2

Windows Server 2019 and Windows Server 2022 do not introduce new functional levels and use the highest functional level of Windows Server 2016.
{: note)

## Ensuring Support for Common Encryption Types in AD and RHEL
{: #encryption-types-ad-rhel}

Samba Winbind supports RC4, AES-128, and AES-256 Kerberos encryption types by default. However, RC4 encryption is deprecated and disabled by default due to security considerations. AD user credentials and trusts may still rely on RC4 encryption, leading to authentication issues.

To ensure compatibility, you have two options:
*  Enable AES encryption support in Active Directory.
*  Enable RC4 support in RHEL.

For enabling RC4 support in RHEL, the steps differ depending on the RHEL version. It is recommended to refer to the official documentation for detailed instructions.

## Procedure
{: #procedure}

Samba Winbind is an alternative to the System Security Services Daemon (SSSD) for connecting a Red Hat Enterprise Linux (RHEL) system with Active Directory (AD). This section describes how to join an RHEL system to an AD domain by using realmd to configure Samba Winbind. 

Join a Symphony Cluster node, which is hosted on RHEL 8.4 OS to an AD domain by using Samba Winbind and `realmd``:

1.  Install and update the following packages: 

    ```shell
    # yum install realmd oddjob-mkhomedir oddjob samba-winbind-clients \
    samba-winbind samba-common-tools samba-winbind-krb5-locator

    #yum update
    ```

2.  Updating the /etc/hosts with adding AD domain ip and name.  For example:

    ```shell
    [root@amit-rhel84 ~]# cat /etc/hosts
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
    10.243.0.41 addc1.POCDomain.local
    ```

    addc1.POCDomain.local is the AD server FQDN name
    {: note}

3.  Update the DNS entries in /etc/resolv.conf file by using:  

    `sudo nmcli connection modify "System eth0" ipv4.dns "10.243.0.41" ipv4.ignore-auto-dns yes`

    This command not only updates the DNS entries in the /etc/resolv.conf file but also ensures that the DNS entries are not auto updated to cloud based DNS servers

4.  Confirm the changes in the DNS file:

    ```shell
    [root@amit-rhel84 ~]# cat /etc/resolv.conf
    # Generated by NetworkManager
    nameserver 10.243.0.41
    [root@amit-rhel84 ~]#
    ```

   In addition to the above confirmation, ping the Domain Controller with Name : - Ping POCDOMAIN.LOCAL
shell
    ```
    [root@amit-rhel84 ~]# ping POCDOMAIN.LOCAL
    PING POCDOMAIN.LOCAL (10.243.0.41) 56(84) bytes of data.
    64 bytes from addc1.POCDomain.local (10.243.0.41): icmp_seq=1 ttl=128 time=0.365 ms
    64 bytes from addc1.POCDomain.local (10.243.0.41): icmp_seq=2 ttl=128 time=0.722 ms
    64 bytes from addc1.POCDomain.local (10.243.0.41): icmp_seq=3 ttl=128 time=0.581 ms
    64 bytes from addc1.POCDomain.local (10.243.0.41): icmp_seq=4 ttl=128 time=0.525 ms

5.  Use `nslookup` to make sure that AD domain is resolvable:

    ```shell
    [root@amit-rhel84 ~]#  nslookup pocdomain.local
    Server:         10.243.0.41
    Address:        10.243.0.41#53

    Name:   pocdomain.local
    Address: 10.243.0.41
    ```

6.  If your Active Directory requires the deprecated RC4 encryption type for Kerberos authentication, enable support for these ciphers in RHEL: 

    `# update-crypto-policies --set DEFAULT:AD-SUPPORT`

    After running this command, update the crypto policies and ask to restart the system.


7.  Back up the existing /etc/samba/smb.conf Samba configuration file: 

    `# mv /etc/samba/smb.conf /etc/samba/smb.conf.bak`

8.  Join the RHEL 8.x host to the Active Directory domain. As mentioned in the example to join a domain named POCDOMAIN.LOCAL: 

    `# realm join --membership-software=samba --client-software=winbind POCDOMAIN.LOCAL`

    When you use this command, the realm utility automatically: 
    *  Creates a /etc/samba/smb.conf file for a membership in the pocdomain.local domain 
    *  Adds the winbind module for user and group lookups to the /etc/nsswitch.conf file 
    *  Updates the Pluggable Authentication Module (PAM) configuration files in the /etc/pam.d/ directory 
    *  Starts the winbind service and enables the service to start when the system boots 


9.  (Optional) Set an alternative ID mapping back end or customized ID mapping settings in the /etc/samba/smb.conf file. For details, see the [Understanding and configuring Samba ID mapping](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/deploying_different_types_of_servers/assembly_using-samba-as-a-server_deploying-different-types-of-servers). 

10.  Edit the /etc/krb5.conf file and add this section: 

    ```
     [plugins]
      localauth = {
        module = winbind:/usr/lib64/samba/krb5/winbind_krb5_localauth.so
        enable_only = winbind
     }

11.  Verify that the winbind service is running. For example:

     ```shell
     # systemctl status winbind
     [root@amit-rhel84 ~]# systemctl status winbind
     winbind.service - Samba Winbind Daemon
     Loaded: loaded (/usr/lib/systemd/system/winbind.service; enabled; vendor preset: disabled)
     Active: active (running) since Wed 2023-08-09 08:16:16 EDT; 1h 42min ago
     Docs: man:winbindd(8)
           man:samba(7)
           man:smb.conf(5)
     Main PID: 4889 (winbindd)
       Status: "winbindd: ready to serve connections..."
       Tasks: 5 (limit: 49264)
      Memory: 10.9M
      CGroup: /system.slice/winbind.service
           ├─4889 /usr/sbin/winbindd --foreground --no-process-group
           ├─4893 /usr/sbin/winbindd --foreground --no-process-group
           ├─4894 /usr/sbin/winbindd --foreground --no-process-group
           ├─4924 /usr/sbin/winbindd --foreground --no-process-group
           └─5997 /usr/sbin/winbindd --foreground --no-process-group Important
     ```

12.  If you installed the samba package to share directories and printers, enable and start the smb service: 

     `# systemctl enable --now smb ----tobe noted`

### Verification steps
{: #verification-steps}


1.  Display an AD user’s details, such as the AD administrator account in the AD domain.  For example: 
    `# getent passwd " POCDOMAIN\administrator"
    POCDOMAIN\administrator:*:2000500:2000513::/home/administrator@POCDOMAIN:/bin/bash`
2.  Query the members of the domain users group in the AD domain: 
    `# getent group " POCDOMAIN\Domain Users"
    POCDOMAIN\domain users:x:10000:Symphonyuser01,user2`

3.  (Optional) Verify that you can use domain users and groups when you set permissions on files and directories. For example, to set the owner of the /srv/samba/example.txt file to AD\administrator and the group to AD\Domain Users: 

    `# sudo chown "POCDOMAIN\administrator":"POCDOMAIN\Domain Users" example.txt`
4.  Verify that Kerberos authentication works as expected. On the AD domain member, obtain a ticket for the administrator@POCDOMAIN.LOCAL principal: 
        `# kinit administrator@POCDOMAIN.LOCAL`

5.  Display the cached Kerberos ticket: 
    `# klist
    Ticket cache: KCM:0
    Default principal: Administrator@POCDOMAIN.LOCAL
    Valid starting       Expires              Service principal
    07/10/2023 16:28:51  07/11/2023 02:28:51  krbtgt/POCDOMAIN.LOCAL@POCDOMAIN.LOCAL
            renew until 07/17/2023 16:28:46`
6.  Display the available domains: 

    ```shell
    [root@rhelad01 ~]# realm list
    pocdomain.local
    pocdomain.local
     type: kerberos
     realm-name: POCDOMAIN.LOCAL
     domain-name: pocdomain.local
     configured: kerberos-member
     server-software: active-directory
     client-software: winbind
     required-package: oddjob-mkhomedir
     required-package: oddjob
     required-package: samba-winbind-clients
     required-package: samba-winbind
     required-package: samba-common-tools
     login-formats: POCDOMAIN\%U
     login-policy: allow-any-login
        [root@rhelad01 ~]# wbinfo --all-domains
        BUILTIN
        RHELAD01
        POCDOMAIN

        POCDOMAIN
    ```
    Additional resources
    * If you do not want to use the deprecated RC4 ciphers, you can enable the AES encryption type in AD. 

### To provide root user permissions to Active Directory (AD) users
{: #provide-root-permission}

To provide root user permissions to AD users of "POCDOMAIN.LOCAL" domain on a Linux system:
1.  Open a terminal or connect to the Linux system.
2.  Edit the sudoers file using the visudo command:
    `sudo visudo`
3.  Locate the section in the sudoers file that configures user privileges:

    `# Allow root to run any commands anywhere root ALL=(ALL) ALL`

4.  Add the following line below the root user entry to allow AD users in the "POCDOMAIN\Domain Administrators" group to execute commands with root privileges:
    `%POCDOMAIN\\Domain\ Administrators ALL=(ALL) ALL`

    This line grants root user privileges to all AD users in the "POCDOMAIN\Domain Users" group. The double backslashes ("") are used to escape special characters.
5.  Save the changes to the sudoers file and exit the editor.
    AD users who are members of the "POCDOMAIN\Domain Users" group can now execute commands with root privileges by using the sudo command. For example:
    `sudo command_to_execute_as_root`

    When prompted, the AD user must enter their own password to authenticate and execute the command with elevated privileges.

   Exercise caution when granting root user permissions to AD users. It's important to grant these privileges only to trusted individuals who require them for specific tasks. Regularly reviewing user privileges and following security best practices will help maintain a secure system environment.
{: important}

